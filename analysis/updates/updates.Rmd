---
title: "January 13"
output: 
  bookdown::pdf_document2:
    number_sections: false
    toc: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache = FALSE, dev = "ragg_png", dpi=200)
library(tidyverse)
library(patchwork)

source(here::here("R", "updates.R"))
# Sys.setenv(TAR_PROJECT = "ale")
# tar_config_set(store = here::here("_ale"))


plot_dist <- function(outqs, min_cluster=10){
  qs::qread(outqs) |>
    filter(!str_detect(label, "Brain-Stem")) |>
    filter(cluster_size > min_cluster) |>
    mutate(label = str_c(label, cluster_size, sep = " ")) |>
    group_by(label, n_sub, iter, cluster_size, sign) |>
    summarise(d = min(d), .groups = "drop") |>
    WISEsummary(
      dependentvars = "d",
      betweenvars = c("n_sub", "label", "cluster_size","sign")) |>
    ggplot(aes(x=n_sub, y=d_mean, group=interaction(cluster_size,sign))) + 
    facet_wrap(
      ~label, 
      # scales = "free_y",
      labeller = ggplot2::label_wrap_gen(width = 20)) +
    geom_line() +
    scale_x_continuous(trans = "log10") +
    geom_errorbar(aes(ymin=d_CI_lower, ymax=d_CI_upper)) +
    ylab("Avg. Distance From Reference (mm)") +
    xlab("N Participants") +
    theme_gray(base_size = 8) 
}

plot_tmp <- function(outqs, min_cluster=10){
  qs::qread(outqs) |>
    filter(!str_detect(label, "Brain-Stem")) |>
    filter(cluster_size > min_cluster) |>
    mutate(label = str_c(label, cluster_size, sep = " ")) |>
    group_by(label, n_sub, iter, cluster_size, sign) |> 
    filter(d == min(d)) |> 
    ungroup() |> 
    group_nest(n_sub, sign, label, cluster_size) |> 
    mutate(
      avg = map(
        data, 
        ~tibble(d=as.vector(dist(cbind(.x$x.study,.x$y.study,.x$z.study)))) |> 
          WISEsummary(dependentvars = "d") )) |> 
    select(-data) |> 
    unnest(avg) |> 
    ggplot(aes(x=n_sub, y=d_mean, group=interaction(cluster_size,sign))) + 
    facet_wrap(
      ~label, 
      labeller = ggplot2::label_wrap_gen(width = 20)) +
    geom_line() +
    scale_x_continuous(trans = "log10") +
    geom_errorbar(aes(ymin=d_CI_lower, ymax=d_CI_upper)) +
    ylab("Avg. Distance Between Studies (mm)") +
    xlab("N Participants") +
    theme_gray(base_size = 8)
}

```


## Spacetop

I've moved some of the data to the JHPCE cluster. This has been done with Datalad, which includes tools for retrieving whichever parts of data are actively being processed (e.g., individual participants being run through fmriprep). However, there is some difficulty in accessing the Dartmouth cluster from the JHPCE, so it looks like it would be helpful if we could store an entire copy of the dataset and derivatives at Johns Hopkins. Is there an update on freeing space up at `/dcl01/smart`?

## Population Effect Sizes

I'm mainly working on trying to better understand the spatial precision of estimated effects. For this analysis, I've looked at a couple of variations, but the steps for this update are as follows. The reference dataset comprised 5000 participants. This gold-standard was compared against simulated studies with smaller sample sizes (10, 20, 30, 50, 100, 250, 500, 1000 participants), and each simulation repeated 20 times. In both the reference and smaller studies, the resulting z-maps were used to find clusters of activation (using FSL's `cluster`), using a cluster forming threshold of p < 0.001 (Figure 1) or p < 0.05 (Figure 2). This resulted in a set of clusters and peaks for the reference dataset (reference peaks) and each of the simulated studies (study peaks).

A primary question is "how well can these smaller studies localize a peak activation as a function of sample size?". As a measure of accuracy, I have been looking at the smallest distance between each local reference peak within a cluster and any of the test peaks(Figures 1A,2A). As a measure of precision, I have been looking at the average distance of the study peaks from each other (Figures 1B, 2B). In general, localization improves with sample size, although that relationship is not clear in some of the clusters (e.g., both very large and very small clusters; Figure 2).

```{r, fig.cap="Average Distance of Study Peaks From (A) Reference and (B) Each Other. Panel labels give the number of voxels within the reference peak's cluster. Cluster forming threshold was p < 0.001. Error bars span 95% confidence intervals.", fig.width=9}
out <- qs::qread(here::here("data-raw/out0.qs")) |>
  # group_by(n_sub, iter, `Cluster Index`) |> 
  # slice_max(order_by = abs(Value), n=1) |>
  # filter(cluster_size > 10) |>
  group_by(n_sub, iter, `Cluster Index`) |>
  slice_min(d, n=1, with_ties = FALSE) |> 
  ungroup() 

a <- out |> 
  WISEsummary(
    dependentvars = "d",
    betweenvars = c("n_sub", "cluster_size")) |>
  rename(size=cluster_size) |>
  ggplot(aes(x=n_sub, y=d_mean)) + 
  facet_wrap(~size, labeller = "label_both") +
  scale_x_continuous(trans = "log10") +
  geom_line() +
  geom_errorbar(aes(ymin=d_CI_lower, ymax=d_CI_upper)) +
  ylab("Avg. Distance From Reference (mm)") +
  xlab("N Participants") +
  theme_gray(base_size = 8) 


b <- out |>
  group_nest(n_sub, cluster_size) |> 
  mutate(
    avg = map(
      data, 
      ~tibble(d=as.vector(dist(cbind(.x$x.study,.x$y.study,.x$z.study)))) |> 
        WISEsummary(dependentvars = "d") )) |> 
  select(-data) |> 
  unnest(avg) |> 
  rename(size=cluster_size) |>
  ggplot(aes(x=n_sub, y=d_mean)) + 
  facet_wrap(~size, labeller = "label_both") +
  geom_line() +
  scale_x_continuous(trans = "log10") +
  geom_errorbar(aes(ymin=d_CI_lower, ymax=d_CI_upper)) +
  ylab("Avg. Distance Between Studies (mm)") +
  xlab("N Participants") +
  theme_gray(base_size = 8)

a + b + plot_annotation(tag_levels = "A", tag_suffix = ")")

```


```{r, fig.cap="Average Distance of Study Peaks From (A) Reference and (B) Each Other. Panel are labeled as in Figure 1. Cluster forming threshold was p < 0.05. Error bars span 95% confidence intervals.", fig.width=9}
out <- qs::qread(here::here("data-raw/out1.6.qs")) |>
  group_by(n_sub, iter, `Cluster Index`) |> 
  # slice_max(order_by = abs(Value), n=1) |>
  # filter(cluster_size > 10) |>
  # group_by(n_sub, iter) |>
  slice_min(d, n=1, with_ties = FALSE) |> 
  ungroup() 

a <- out |> 
  WISEsummary(
    dependentvars = "d",
    betweenvars = c("n_sub", "cluster_size")) |>
  ggplot(aes(x=n_sub, y=d_mean)) + 
  facet_wrap(~cluster_size, labeller = "label_both") +
  geom_line() +
  scale_x_continuous(trans = "log10") +
  geom_errorbar(aes(ymin=d_CI_lower, ymax=d_CI_upper)) +
  ylab("Avg. Distance From Reference (mm)") +
  xlab("N Participants") +
  theme_gray(base_size = 8) 


b <- out |>
  group_nest(n_sub, cluster_size) |> 
  mutate(
    avg = map(
      data, 
      ~tibble(d=as.vector(dist(cbind(.x$x.study,.x$y.study,.x$z.study)))) |> 
        WISEsummary(dependentvars = "d") )) |> 
  select(-data) |> 
  unnest(avg) |> 
  ggplot(aes(x=n_sub, y=d_mean)) + 
  facet_wrap(~cluster_size, labeller = "label_both") +
  geom_line() +
  scale_x_continuous(trans = "log10") +
  geom_errorbar(aes(ymin=d_CI_lower, ymax=d_CI_upper)) +
  ylab("Avg. Distance Between Studies (mm)") +
  xlab("N Participants") +
  theme_gray(base_size = 8)

a + b + plot_annotation(tag_levels = "A", tag_suffix = ")")

```


At both thresholds, many clusters spanned multiple anatomical regions. To assess how the peak localization varied across the brain, the above procedure was repeated but with the clusters replaced by anatomical region. That is, reference peaks were first grouped by anatomical region. Then, each local peak (from the reference study) within a region was compared against all study peaks, and the minimum distance for that region was recorded. This resulted in a single distance for each region that has a local peak in the gold-standard. 

This anatomical grouping is the closest to what we've looked at before. The results have a few odd features that I cannot explain fully, like how the studies appear to get worse at localizing the reference peaks within the Left Amygdala, Hippocampus, and Occipital Pole as sample size increase (Figure 3). We had seen a similar oddity before, where it looked like the spatial precision increased for a few regions between samples sizes of 10 to 50. Increasing the number of participants in the reference scan seems to have removed that. As a sanity check, the average distances from the reference must necessarily to 0 as the study size approaches the reference sample size, so perhaps further increasing the numbers will smooth out these region-specific plots.


```{r, space, fig.cap="Average Distance of Study Peaks From (A) Reference and (B) Each Other. Panel labels correspond to the location of the local peak in the reference study and the number of the voxels within the peak's cluster. Note that cluster sizes are repeated due to clusters containing many local peaks. Cluster forming threshold was p < 0.001. Error bars span 95% confidence intervals.", fig.width=9}

a <- plot_dist(here::here("data-raw/out0.qs")) +
  ylim(0,30)

b <- plot_tmp(here::here("data-raw/out0.qs"))

a + b + plot_annotation(tag_levels = "A", tag_suffix = ")")

```


```{r, space2, fig.cap="Average Distance of Study Peaks From (A) Reference and (B) Each Other. Panels are labeled as in Figure 1. Cluster forming threshold was p < 0.05. Error bars span 95% confidence intervals.", fig.width=9}

a <- plot_dist(here::here("data-raw/out1.6.qs")) +
  ylim(0,30)

b <- plot_tmp(here::here("data-raw/out1.6.qs"))

a + b + plot_annotation(tag_levels = "A", tag_suffix = ")")

```

