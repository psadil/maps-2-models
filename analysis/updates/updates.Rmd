---
title: "January 20"
output: 
  bookdown::pdf_document2:
    number_sections: false
    toc: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache = FALSE, dev = "ragg_png", dpi=200)
library(tidyverse)
library(patchwork)

source(here::here("R", "updates.R"))
# Sys.setenv(TAR_PROJECT = "ale")
# tar_config_set(store = here::here("_ale"))

point_size <- 1

plot_dist <- function(outqs, min_cluster=10, ps=point_size){
  qs::qread(outqs) |>
    filter(!str_detect(label, "Brain-Stem")) |>
    filter(cluster_size > min_cluster) |>
    mutate(label = str_c(label, cluster_size, sep = " ")) |>
    group_by(label, n_sub, iter, cluster_size, sign) |>
    summarise(d = min(d), .groups = "drop") |>
    mutate(n_sub = factor(n_sub)) |>
    # WISEsummary(
    #   dependentvars = "d",
    #   betweenvars = c("n_sub", "label", "cluster_size","sign")) |>
    ggplot(aes(y=n_sub, x=d)) + 
    facet_wrap(
      ~label, 
      # scales = "free_y",
      labeller = ggplot2::label_wrap_gen(width = 20)) +
    ggridges::geom_density_ridges(
      jittered_points = TRUE,
      position = ggridges::position_points_jitter(width = 0.05, height = 0),
      point_shape = '|', 
      point_size = ps, 
      point_alpha = 1, 
      alpha = 0.7,
      rel_min_height = 0.01) +
    # geom_line() +
    # scale_x_continuous(trans = "log10") +
    # geom_errorbar(aes(ymin=d_CI_lower, ymax=d_CI_upper)) +
    xlab("Avg. Distance From Reference (mm)") +
    ylab("N Participants") +
    theme_gray(base_size = 8) 
}

plot_tmp <- function(outqs, min_cluster=10){
  qs::qread(outqs) |>
    filter(!str_detect(label, "Brain-Stem")) |>
    filter(cluster_size > min_cluster) |>
    mutate(label = str_c(label, cluster_size, sep = " ")) |>
    group_by(label, n_sub, iter, cluster_size, sign) |> 
    filter(d == min(d)) |> 
    ungroup() |> 
    group_nest(n_sub, sign, label, cluster_size) |> 
    mutate(
      avg = map(
        data, 
        ~tibble(d=as.vector(dist(cbind(.x$x.study,.x$y.study,.x$z.study)))) |> 
          WISEsummary(dependentvars = "d") )) |> 
    select(-data) |> 
    unnest(avg) |> 
    ggplot(aes(x=n_sub, y=d_mean, group=interaction(cluster_size,sign))) + 
    facet_wrap(
      ~label, 
      labeller = ggplot2::label_wrap_gen(width = 20)) +
    geom_line() +
    scale_x_continuous(trans = "log10") +
    geom_errorbar(aes(ymin=d_CI_lower, ymax=d_CI_upper)) +
    ylab("Avg. Distance Between Studies (mm)") +
    xlab("N Participants") +
    theme_gray(base_size = 8)
}

```


## Biobank

One participant appears to have corrupted task fMRI data 1435310 . That is, they have data files, but the files are all of size 0.

(`/dcl01/smart/data/UKBiobank/task_fMRI/1435310_20249_2_0/fMRI/tfMRI.feat`)

## Spacetop

This is a small technical update to say that processing for this is being run. It would still be nice to use `/dcl01/smart/data` as data, but I can make decent headway with the scratch space

## Population Effect Sice / Precision

I'm still trying to understand why grouping reference peaks by anatomical region seems to cause localization to worsen with increasing study size, for some regions. Figure 2 highlights the issue. It seems like the individual studies are finding one of two peaks, although only one of these peaks shows up in the reference region. I assume this has something to do with how the local peaks are thresholded, but I'm need to look more closely at that procedure. 

```{r, space, fig.cap="Average Distance of Study Peaks From (A) Reference and (B) Each Other. Panel labels correspond to the location of the local peak in the reference study and the number of the voxels within the peak's cluster. Note that cluster sizes are repeated due to clusters containing many local peaks. Cluster forming threshold was p < 0.001. Error bars span 95% confidence intervals.", fig.width=9}

a <- plot_dist(here::here("data-raw/out0.qs")) +
  xlim(0,50)

b <- plot_tmp(here::here("data-raw/out0.qs"))

a + b + plot_annotation(tag_levels = "A", tag_suffix = ")")
# a
```


```{r, spaceC, fig.cap="Individual study peaks labeled by region", fig.width=9}

out <- qs::qread(here::here("data-raw/out0.qs")) |>
  filter(!str_detect(label, "Brain-Stem")) |>
  filter(cluster_size > 10) |>
  mutate(label = str_c(label, cluster_size, sep = " ")) |>
  group_by(label, n_sub, iter, cluster_size, sign) |>
  slice_min(d, n=1) |>
  ungroup() |>
  mutate(n_sub = factor(n_sub)) 

label.study <- out |> 
  distinct(label, label.study) |>
  group_nest(label) |>
  mutate(
    data = map(
      data, 
      ~distinct(.x,label.study) |>
        mutate(ls = factor(label.study) |> as.numeric()))) |>
  unnest(data) |>
  mutate(ls = factor(ls))


out |>
  filter(str_detect(label, "Left Amyg")) |>
  left_join(label.study, by = c("label","label.study")) |>
  mutate(
    label.hemi = if_else(x.study > 45, "Left ", "Right "),
    label.study = if_else(str_detect(label.study, "Left|Right"), label.study, str_c(label.hemi, label.study))) |>
  ggplot(aes(y=n_sub, x=d)) + 
  facet_wrap(
    ~label, 
    # scales = "free_y",
    labeller = ggplot2::label_wrap_gen(width = 20)) +
  ggridges::geom_density_ridges(alpha = 0.7,
    rel_min_height = 0.01) +
  geom_point(aes(color=label.study), shape = 3, stroke=3, alpha =0.3) + 
  xlab("Avg. Distance From Reference (mm)") +
  ylab("N Participants") +
  theme_gray(base_size = 8) 


# b <- plot_tmp(here::here("data-raw/out0.qs"))

# a + b + plot_annotation(tag_levels = "A", tag_suffix = ")")
# a
```

