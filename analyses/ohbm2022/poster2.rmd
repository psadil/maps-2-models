---
output: 
  pagedown::poster_relaxed:
    self_contained: false
    pandoc_args: --mathjax
    number_sections: false
    template: /home/ubuntu/mnt/meta/meta/analyses/ohbm2022/template.html
titlebox_height: "12%"
poster_height: "118.8cm"
poster_width: "84cm"
column_numbers: 2
title: '**Reliability of Effect Sizes and Spatial Localization with Population-Level Sample Sizes**'
author:   
  - name: '**Patrick Sadil**'
    main: true
    email: psadil1@jh.edu
  - name: Martin Lindquist
    main: true
    email: 'ml@'
affiliation:
  - address: Johns Hopkins University
# bibliography: packages.bib
link-citations: true
font_family: Palatino
params:
  tfce_store: "/home/ubuntu/mnt/meta/meta/_tfce"
  tfce1_store: "/home/ubuntu/mnt/meta/meta/_tfce1"
  spatial_store: "/home/ubuntu/mnt/meta/meta/_spatial"
---


```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(stringr)
library(patchwork)
source(here::here("R","utils.R"))
source(here::here("R","tfce.R"))
source(here::here("R","updates.R"))
source(here::here("R","poster.R"))
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      tidy = FALSE,
                      message = FALSE,
                      fig.align = 'center',
                      out.width = "100%",
                      cache=TRUE,
                      dpi = 300)
options(knitr.table.format = "html") 

regions <- "Amygdala|Occipital Pole"

point_size <- 1
```


# Background 

- Decades of fMRI research on brain-behavior relationships are obscured by small samples (Figure \@ref(fig:fluid); Marek et al. 2022)
- Large-scale studies provide a way to calibrate expectations

# General Methods

- Bootstrap samples from part of UK Biobank (10000 participants) to simulate studies of several sample sizes (10, 20, 50, 100, 200, 500)
- Calculate metrics from simulated studies
- Compare study metrics to "Gold Standard" -- metrics derived from held out UK Biobank (8526 participants)

# Results & Replication: Effect Sizes

```{r, fluid, fig.height=3, fig.cap="Prior variability in effect magnitudes and direction can be accounted for by sampling variability alone. Distributions show correlation between brain volume and fluid intelligence at multiple sample sizes. At typical sample sizes of early studies (under 200), the sign is often. At larger samples, estimates become reliable."}

targets::tar_load(out, store = "/home/ubuntu/mnt/meta/poster/_targets.bak")
# targets::tar_load(lit)

lit <- readxl::read_excel(here::here("data-raw", "lit-review.xlsx")) |>
  filter(FieldID == 25010) |>
  filter(n < 7000)

out |> 
  filter(FieldID == 25010) |>
  dplyr::mutate(
    N = n,
    Field = stringr::str_remove(Field, " \\(from T1 and T2_FLAIR images\\)")) |>
  ggplot2::ggplot() + 
  geom_vline(xintercept = 0.175) +
  ggridges::stat_density_ridges(
    ggplot2::aes(
      x = correlation, 
      group = N, 
      y = N),
    geom = "density_ridges_gradient",
    bandwidth = 0.03,
    calc_ecdf = TRUE, 
    quantiles = c(0.025, 0.975),
    size = 0.1,
    rel_min_height = 0.01,
    scale = 4) + 
  ggplot2::geom_point(
    data = lit,
    ggplot2::aes(
      x = value, 
      y = n),
    fill = "green", size=5,
    color = "black",
    # alpha = 0.3,
    shape = 21) +
  xlab("Correlation") + 
  ylab("N Participants") +
  ggplot2::scale_fill_manual(
    name = "Quantile",
    values = c("#0000FFA0", "#A0A0A0A0","#FF0000A0"),
    labels = c("(0, 0.025]", "(0.025, 0.975]", "(0.975, 1]")) +
  ggplot2::scale_y_log10() + 
  ggplot2::theme(legend.position = "bottom") +
  scico::scale_fill_scico_d(palette = "vik") +
  scico::scale_color_scico_d(palette = "vik")
```


# Gold Standard 

```{r, gold, fig.height=4, fig.width=6}

space <- filter_space(targets::tar_read(space, store=params$tfce_store), n_peaks=9)

zs <- distinct(space, z)$z

targets::tar_load(tfce_pop, store=params$tfce_store)

to_tbl(tfce_pop$tstat[[1]]) |>
  mutate(value = value / sqrt(tfce_pop$n_sub[[1]])) |>
  filter(z %in% zs) |>
  mutate(a=abs(value)) |>
  ggplot(aes(x=x, y=y)) +
  coord_fixed() +
  facet_wrap(~z, labeller=label_both) +
  geom_raster(
    aes(fill=value),
    data = to_tbl(MNITemplate::getMNIPath(what="Brain", res = "2mm")) |> 
      filter(z%in%zs), show.legend = FALSE) +
  scale_fill_distiller(
    type = "seq",
    direction = -1,
    palette = "Greys") +
  ggnewscale::new_scale_fill() +
  geom_raster(aes(alpha=a, fill=value)) +
  scico::scale_fill_scico(
    palette = "vik", 
    limits=c(-2, 2),
    breaks = c(-1.5, 1.5),
    labels = c(-1.5, 1.5)) +
  scale_alpha_continuous(guide="none",range = c(0.1,1)) +
  geom_point(
    color="red", 
    data=distinct(space, x,y,z), 
    size=3,
    alpha = 0.5) +
  labs(fill="face > shape\n(Cohen's d)") +
  theme_void() +
  theme(
    axis.title=element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "bottom"
  )

```



#  asdf


```{r, fig.height=16, fig.width=16, fig.cap=""}

center <- targets::tar_read(center, store=params$tfce_store)  |>
  filter(z%%10==0) 

a <- center |>
  ggplot(aes(x=x, y=y)) +
  coord_fixed() +
  facet_grid(z~n_sub, labeller=label_both) +
  geom_raster(
    aes(fill=value),
    data = to_tbl(MNITemplate::getMNIPath(what="Brain", res = "2mm")) |> 
      filter(z%in%unique(center$z)), show.legend = FALSE) +
  scale_fill_distiller(
    type = "seq",
    direction = -1,
    palette = "Greys") +
  ggnewscale::new_scale_fill() +
  geom_raster(aes(alpha=a, fill=value)) +
  scico::scale_fill_scico(
    palette = "vik") +
  scale_alpha_continuous(guide="none",range = c(0.3,1)) +
  labs(fill="Avg(Study d) - Pop d") +
  theme_void(base_size = 40) +
  theme(
    axis.title=element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "bottom",
    legend.title = element_text(size = 24),
    legend.text = element_text(size=18),
    legend.key.width = unit(1, 'in')
  )


space <- targets::tar_read(space, store=params$spatial_store) |>
  filter(stringr::str_detect(label, "Amyg|Occipital Pole"))

ref <- space |>
  group_by(label) |>
  summarise(x=mean(x), y=mean(y), z=mean(z)) |>
  mutate(z=if_else(stringr::str_detect(label, "Amyg"), 42, 30))

space1 <- space |>
  mutate(z=if_else(stringr::str_detect(label, "Amyg"), 42, 30))

b <- to_tbl(MNITemplate::getMNIPath(what="Brain", res = "2mm")) |>
  filter(z %in% c(30, 42)) |>
  ggplot(aes(x=x, y=y)) +
  coord_fixed() +
  facet_wrap(~z, labeller=label_both, ncol=1) +
  geom_raster(
    aes(fill=value), show.legend = FALSE, alpha=0.75) +
  scale_fill_distiller(
    type = "seq",
    direction = -1,
    palette = "Greys") +
  geom_point(
    aes(x=x.study, y=y.study, color=n_sub),
    data=space1,
    alpha = 0.2,
    size=5
  ) +
  geom_point(
    aes(x=x, y=y),
    color = "red",
    size=5,
    data = ref) +
  # ggnewscale::new_scale_color() +
  scale_color_viridis_c(option="viridis", trans="log10") +
  # scale_alpha_continuous(guide="none",range = c(0,1)) +
  # labs(fill='face > shape') +
  theme_void(base_size = 40) +
  theme(
    axis.title=element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "none"
  )

a + b + plot_layout(widths = c(5, 1))

```


# Results: Spatial Localization & Precision


```{r, fig.height=17, fig.width=25, fig.cap="Average Distance of Study Peaks From Top 9 Reference Peaks. Panel labels indicate coordinates of the local peak in the reference study. Numbers indicate average distance (mm) of study peaks from each other. Study peaks formed with threshold-free cluster enhancement (p<0.05 FWE on permutation test)."}

s <- filter_space(targets::tar_read(space, store=params$tfce_store), n_peaks=9) |>
  mutate(nsub = as.numeric(as.character(n_sub))) |>
  whoppeR::WISEsummary(dependentvars = "d", betweenvars = "n_sub", withinvars = "group")

filter_space(targets::tar_read(space, store=params$tfce_store), n_peaks=9) |>
  # filter(as.numeric(as.character(n_sub)) > 10) |> 
  ggplot(aes(x=n_sub, y=d)) +
  facet_wrap(~group) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(height = 0, alpha=0.5) +
  geom_text(aes(label=round(d_mean)), y=95, size=18, data=s) +
  ylab("Distance (mm)") +
  xlab("N Participants")  +
  theme_gray(base_size = 48) 


# a <- targets::tar_read(space, store="_tfce") |>
#   filter(str_detect(label, regions)) |>
#   plot_dist() +
#   xlim(0,40) +
#   theme_gray(base_size = 48) 
# targets::tar_read(space, store="_tfce") |>
#   filter(str_detect(label, regions), !is.na(x.study)) |>
#   group_by(label, hemi) |>
#   mutate(most_val = max(Value)) |>
#   ungroup() |>
#   filter(Value == most_val) |>
#   mutate(n_sub=factor(n_sub)) |>
#   ggplot(aes(x=n_sub, y=d)) + 
#   facet_wrap(
#     ~label, 
#     labeller = ggplot2::label_wrap_gen(width = 20)) +
#   geom_boxplot(outlier.shape = NA) +
#   geom_jitter(height = 0, alpha=0.1) +
# ylab("Distance From Ref (mm)") +
# xlab("N Participants") +
#   theme_gray(base_size = 48) 



# x.study can be NA when there was no cluster found
# targets::tar_read(space, store="_tfce") |>
#   filter(str_detect(label, regions), !is.na(x.study)) |>
#   group_by(label, hemi) |>
#   mutate(most_val = max(Value)) |>
#   ungroup() |>
#   filter(Value == most_val) |>
#   group_nest(n_sub, label, sign, hemi) |>
#   mutate(
#     n_sub = factor(n_sub),
#     avg = map(
#       data,
#       ~as.vector(dist(cbind(.x$x.study,.x$y.study,.x$z.study))))) |>
#   select(-data) |>
#   unnest(avg) |> 
#   na.omit() |>
#   ggplot(aes(x=n_sub, y=avg)) + 
#   facet_wrap(
#     ~label, 
#     labeller = ggplot2::label_wrap_gen(width = 20)) +
#   geom_boxplot(outlier.shape = NA) +
#   geom_jitter(height = 0, alpha=0.1) +
#   ylab("Distance Between Studies (mm)") +
#   xlab("N Participants") +
#   theme_gray(base_size = 48) 

# a / b + plot_layout(guides = "collect")
```


# Results: Global Correlation

```{r, globalcor, fig.height=3, fig.cap="Frist"}

targets::tar_read(rho_quants, store=params$tfce_store) |>
  ggplot(aes(x=n_sub)) +
  geom_boxplot(
    aes(y=rho, color=gold_cut),
    outlier.alpha = 0.5) 

```


# Results: Global Correlation2

```{r, globalcor2, fig.height=3, fig.cap="Second"}

targets::tar_load(iters, store = params$tfce_store)

sigs <- distinct(iters, n_sub) |>
  crossing(p = c(0.01, 0.001)) |>
  mutate(
    lower = qt(p, n_sub-1) / sqrt(n_sub),
    upper = qt(p, n_sub-1, lower.tail = FALSE) / sqrt(n_sub))

filtered_space <- filter_space(targets::tar_read(space, store=params$tfce_store), 9) |>
  distinct(label) |>
  filter(stringr::str_detect(label, "Amyg|Occipital Fusiform|Occipital Pole")) |>
  mutate(
    text = case_when(
      label == "Temporal Occipital Fusiform Cortex" ~ "Temp. Occipital Fus.",
      label == "Occipital Fusiform Gyrus" ~ "Occ. Fus. Gyr.",
      str_detect(label, "Amyg")  ~ "Amygdala",
      TRUE ~ "Occipital Pole"
    ))

gold_meds <- targets::tar_read(pop_d, store=params$tfce_store) |>
  left_join(targets::tar_read(at, store=params$tfce_store)) |>
  right_join(filtered_space) |>
  group_by(text) |>
  summarise(gold = median(gold)) |>
  mutate(
    y = c(-.5, -.75, -1, -.25),
    hjust = c("left", "right", "right", "left"))

iters |>
  select(-s, average) |>
  pivot_longer(cols = c(q.05, q.95, average), names_to = "stat") |>
  mutate(quantile = if_else(stat=="average", "average", "90%")) |>
  ggplot(aes(x=gold)) +
  facet_wrap(~n_sub) +
  geom_vline(
    data = gold_meds,
    aes(xintercept = gold),
    alpha = 0.25) +
  geom_text(
    data = gold_meds,
    aes(x = gold, y=y, label=text, hjust=hjust)) +
  geom_hline(
    data = sigs,
    aes(yintercept = upper),
    alpha = 0.25) +
  geom_text(
    data = mutate(
      sigs, 
      upper = if_else(p==0.01, upper-.1, upper+.1),
      p = glue::glue("p = {p}")),
    aes(y=upper, label = p),
    x = -0.5) +
  geom_abline(slope=1, intercept=0, alpha=0.5) +
  geom_line(aes(y=value, linetype = quantile, group=stat)) +
  scale_linetype_manual(
    name = "Study Stat",
    breaks = c("average", "90%"),
    values = c("average"="dashed", "90%"="dotted")) +
  xlab("Gold Standard d") +
  ylab("Study d")

```

